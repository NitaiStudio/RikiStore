<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Riki Store</title>
    <meta name="theme-color" content="#6200ea">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="https://i.ibb.co/L8WdYKc/logo-192.png">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #6200ea; --surface: #ffffff; --bg: #f5f5f5; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: var(--bg); font-family: 'Roboto', sans-serif; }
        .hidden { display: none !important; }

        /* Splash */
        #splash-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--surface); z-index: 2000; display: flex; justify-content: center; align-items: center; flex-direction: column; transition: opacity 0.5s; }
        .logo { width: 100px; height: 100px; background: var(--primary); border-radius: 20px; display: flex; align-items: center; justify-content: center; color: white; font-size: 40px; font-weight: bold; box-shadow: 0 4px 15px rgba(98,0,234,0.4); }

        /* Header */
        .header { background: var(--surface); padding: 15px; position: sticky; top: 0; z-index: 100; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .auth-btn { background: var(--primary); color: white; padding: 6px 14px; border-radius: 20px; font-size: 14px; border: none; font-weight: bold; }
        #install-btn { display: none; background: #333; color: white; padding: 6px 12px; border-radius: 5px; font-size: 12px; border: none; margin-right: 10px; }

        /* Content */
        #main-app { padding-bottom: 70px; }
        .page { display: none; padding: 15px; animation: fadeIn 0.3s; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Product Card */
        .product-card { background: var(--surface); border-radius: 12px; overflow: hidden; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .p-img-container { width: 100%; height: 180px; background: #eee; }
        .p-img { width: 100%; height: 100%; object-fit: cover; }
        .p-details { padding: 12px; }
        .p-row { display: flex; justify-content: space-between; align-items: center; margin-top: 8px; }
        .btn-view { background: #ede7f6; color: var(--primary); border: none; padding: 6px 15px; border-radius: 15px; font-weight: bold; font-size: 12px; }

        /* Full Screen Modal */
        .fs-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 1500; display: none; flex-direction: column; animation: slideUp 0.3s; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .fs-header { padding: 15px; border-bottom: 1px solid #eee; display: flex; gap: 15px; align-items: center; }
        .fs-content { flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 80px; }
        .fs-bottom { position: fixed; bottom: 0; left: 0; width: 100%; background: white; padding: 10px 15px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); display: flex; gap: 10px; }
        .btn-buy-now { flex: 1; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: bold; font-size: 16px; }

        /* Center Modal */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; z-index: 2000; justify-content: center; align-items: center; }
        .modal-content { background: white; width: 90%; max-width: 350px; padding: 20px; border-radius: 16px; position: relative; }
        .close-icon { position: absolute; top: 10px; right: 15px; font-size: 24px; cursor: pointer; }
        input { width: 100%; padding: 12px; margin: 8px 0 15px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .btn-full { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: bold; }

        /* Orders */
        .order-card { background: white; padding: 15px; border-radius: 12px; margin-bottom: 10px; border-left: 5px solid #ddd; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .order-card.approved { border-left-color: #2e7d32; }
        .order-card.rejected { border-left-color: #c62828; }
        .d-btn { display: block; text-align: center; background: #2e7d32; color: white; padding: 10px; text-decoration: none; border-radius: 8px; margin-top: 10px; font-weight: bold; }

        /* Bottom Nav */
        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: var(--surface); display: flex; padding: 10px 0; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); z-index: 100; height: 60px; }
        .nav-item { flex: 1; text-align: center; color: #999; font-size: 10px; display: flex; flex-direction: column; justify-content: center; }
        .nav-item.active { color: var(--primary); font-weight: bold; }
        .nav-item span { font-size: 20px; margin-bottom: 2px; }
    </style>
</head>
<body>

<div id="splash-screen">
    <div class="logo">R</div>
    <h1 style="color:#333; margin-top:10px;">Riki Store</h1>
</div>

<div id="main-app" class="hidden">
    <div class="header">
        <h1 style="margin:0; font-size:20px; color:var(--primary);">Riki Store</h1>
        <div style="display:flex; align-items:center;">
            <button id="install-btn" onclick="installApp()">Install App</button>
            <button id="auth-btn" class="auth-btn" onclick="handleAuth()">Login</button>
        </div>
    </div>

    <!-- Home Page -->
    <div id="home-page" class="page active">
        <div id="products-container"><p style="text-align:center;">Loading...</p></div>
    </div>

    <!-- Orders Page -->
    <div id="orders-page" class="page">
        <h3 style="margin-top:0;">My Purchases</h3>
        <div id="orders-container"></div>
    </div>

    <!-- Profile Page -->
    <div id="profile-page" class="page">
        <h3 style="margin-top:0;">Profile</h3>
        <div id="profile-content"></div>
    </div>

    <div class="bottom-nav">
        <div class="nav-item active" onclick="nav('home', this)"><span>üè†</span>Home</div>
        <div class="nav-item" onclick="nav('orders', this)"><span>üõçÔ∏è</span>Orders</div>
        <div class="nav-item" onclick="nav('profile', this)"><span>üë§</span>Profile</div>
    </div>
</div>

<!-- Product Details Modal -->
<div id="productModal" class="fs-modal">
    <div class="fs-header"><span onclick="closeFsModal()" style="font-size:24px; cursor:pointer;">‚Üê</span> <b>Details</b></div>
    <div class="fs-content">
        <img id="m_img" style="width:100%; height:250px; object-fit:cover; border-radius:10px; background:#eee;">
        <h2 id="m_title" style="margin:10px 0;"></h2>
        <h3 id="m_price" style="color:#2e7d32; margin:0 0 15px;"></h3>
        <div style="background:#f9f9f9; padding:10px; border-radius:8px;"><p id="m_desc" style="white-space:pre-wrap; margin:0; font-size:14px; color:#555;"></p></div>
    </div>
    <div class="fs-bottom">
        <a id="m_demo" href="#" target="_blank" style="flex:1; text-align:center; padding:12px; border:1px solid #6200ea; color:#6200ea; border-radius:8px; text-decoration:none; font-weight:bold;">Demo</a>
        <button class="btn-buy-now" onclick="checkLoginAndBuy()">Buy Now</button>
    </div>
</div>

<!-- Buy Modal -->
<div id="buyModal" class="modal">
    <div class="modal-content">
        <span class="close-icon" onclick="closeModal('buyModal')">&times;</span>
        <h3>Payment</h3>
        <p>Amount: <b>‚Çπ<span id="b_amount"></span></b></p>
        <a id="upi-link" href="#" class="btn-full" style="display:block; text-align:center; text-decoration:none; background:#2e7d32; margin-bottom:10px;">Pay via UPI</a>
        <p style="font-size:12px; text-align:center; background:#eee; padding:5px;">ID: <b>8327888751@amazonpay</b></p>
        <input type="text" id="trx_id" placeholder="Transaction ID">
        <input type="file" id="trx_img" accept="image/*">
        <button id="confirm-btn" class="btn-full" onclick="confirmPurchase()">Submit Order</button>
    </div>
</div>

<!-- Auth Modal -->
<div id="authModal" class="modal">
    <div class="modal-content">
        <span class="close-icon" onclick="closeModal('authModal')">&times;</span>
        <div id="loginView">
            <h2 style="text-align:center;">Login</h2>
            <input type="email" id="l_email" placeholder="Email">
            <input type="password" id="l_password" placeholder="Password">
            <button class="btn-full" onclick="login()">Login</button>
            <p style="text-align:center; color:#6200ea; cursor:pointer;" onclick="toggleAuthView()">Create Account</p>
        </div>
        <div id="signupView" class="hidden">
            <h2 style="text-align:center;">Sign Up</h2>
            <input type="text" id="s_name" placeholder="Name">
            <input type="email" id="s_email" placeholder="Email">
            <input type="password" id="s_password" placeholder="Password">
            <button class="btn-full" onclick="signup()">Sign Up</button>
            <p style="text-align:center; color:#6200ea; cursor:pointer;" onclick="toggleAuthView()">Back to Login</p>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script>
    const firebaseConfig = { apiKey: "AIzaSyCzLZKJoOmLFfGlwxQHx1GifUasxTDV2Uc", authDomain: "rikiapp-71c4a.firebaseapp.com", databaseURL: "https://rikiapp-71c4a-default-rtdb.firebaseio.com", projectId: "rikiapp-71c4a", appId: "1:822715620946:web:f4fdf78f0b0eafdb8a098b" };
    const IMGBB_API_KEY = "391f65851f9593bedc4225e619cb24e4";
    const UPI_ID = "8327888751@amazonpay";

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();
    let currentUser = null, currentProduct = null, deferredPrompt;

    window.onload = () => {
        if('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');
        window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; document.getElementById('install-btn').style.display = 'block'; });
        setTimeout(() => { document.getElementById('splash-screen').style.display = 'none'; document.getElementById('main-app').classList.remove('hidden'); }, 2000);
    };

    function installApp() {
        if(deferredPrompt) { deferredPrompt.prompt(); deferredPrompt.userChoice.then((r) => { if(r.outcome === 'accepted') document.getElementById('install-btn').style.display = 'none'; deferredPrompt = null; }); }
    }

    auth.onAuthStateChanged(user => {
        currentUser = user;
        if(user) {
            document.getElementById('auth-btn').innerText = "Logout";
            loadOrders();
            loadProfile();
        } else {
            document.getElementById('auth-btn').innerText = "Login";
            document.getElementById('orders-container').innerHTML = "<p style='text-align:center; margin-top:20px;'>Please Login to view orders.</p>";
            document.getElementById('profile-content').innerHTML = "<p style='text-align:center; margin-top:20px;'>Please Login.</p>";
        }
        loadProducts();
    });

    function loadProducts() {
        db.ref('products').on('value', snap => {
            const div = document.getElementById('products-container');
            div.innerHTML = "";
            snap.forEach(c => {
                const p = c.val();
                if(p.status === 'Active') {
                    div.innerHTML += `<div class="product-card" onclick="openP('${c.key}')"><div class="p-img-container"><img src="${p.logo}" class="p-img"></div><div class="p-details"><h3>${p.name}</h3><div class="p-row"><span style="color:#2e7d32; font-weight:bold;">‚Çπ${p.price}</span><button class="btn-view">View</button></div></div></div>`;
                }
            });
        });
    }

    function openP(k) {
        db.ref('products/'+k).once('value', s => {
            currentProduct = { id: k, ...s.val() };
            document.getElementById('m_img').src = currentProduct.logo;
            document.getElementById('m_title').innerText = currentProduct.name;
            document.getElementById('m_price').innerText = "‚Çπ"+currentProduct.price;
            document.getElementById('m_desc').innerText = currentProduct.fullDesc;
            document.getElementById('m_demo').href = currentProduct.demoLink;
            document.getElementById('productModal').style.display = 'flex';
        });
    }

    function loadOrders() {
        // Orders loading logic fixed to work with new rules
        if(!currentUser) return;
        db.ref('purchases').orderByChild('uid').equalTo(currentUser.uid).on('value', snap => {
            const div = document.getElementById('orders-container');
            div.innerHTML = "";
            if(!snap.exists()) { div.innerHTML = "<p style='text-align:center; margin-top:20px;'>No purchases found.</p>"; return; }
            
            const list = [];
            snap.forEach(c => list.push(c.val()));
            list.reverse(); // Show newest first

            list.forEach(o => {
                let btn = "";
                // Logic ensures download button ONLY appears if approved AND link exists
                if(o.status === 'approved' && o.downloadLink) {
                    btn = `<a href="${o.downloadLink}" target="_blank" class="d-btn">Download File</a>`;
                }
                div.innerHTML += `<div class="order-card ${o.status}"><strong>${o.productName}</strong><br>‚Çπ${o.amount} - <span style="text-transform:capitalize; font-weight:bold;">${o.status}</span><br><small>Trx: ${o.trxId}</small>${btn}</div>`;
            });
        });
    }

    function confirmPurchase() {
        const trx = document.getElementById('trx_id').value;
        const file = document.getElementById('trx_img').files[0];
        const btn = document.getElementById('confirm-btn');
        if(!trx || !file) return alert("Missing details");
        
        btn.innerText = "Processing..."; btn.disabled = true;
        const fd = new FormData(); fd.append("image", file);
        
        fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {method:'POST', body:fd})
        .then(r => r.json())
        .then(d => {
            db.ref('users/'+currentUser.uid).once('value', s => {
                const u = s.val();
                db.ref('purchases').push({
                    uid: currentUser.uid, email: currentUser.email, userName: u.name, wa: u.whatsapp,
                    productId: currentProduct.id, productName: currentProduct.name, amount: currentProduct.price,
                    trxId: trx, screenshot: d.data.url, status: 'pending', timestamp: Date.now()
                }).then(() => {
                    alert("Order Placed!"); closeModal('buyModal'); document.getElementById('productModal').style.display='none';
                    nav('orders', document.querySelectorAll('.nav-item')[1]);
                });
            });
        }).catch(()=>alert("Upload Failed")).finally(() => { btn.innerText="Submit Order"; btn.disabled=false; });
    }

    // Standard Helpers
    function nav(p, el) { document.querySelectorAll('.page').forEach(x=>x.classList.remove('active')); document.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('active')); document.getElementById(p+'-page').classList.add('active'); el.classList.add('active'); }
    function handleAuth() { if(currentUser) auth.signOut(); else document.getElementById('authModal').style.display='flex'; }
    function checkLoginAndBuy() { if(!currentUser) { document.getElementById('productModal').style.display='none'; document.getElementById('authModal').style.display='flex'; } else { document.getElementById('b_amount').innerText=currentProduct.price; document.getElementById('upi-link').href=`upi://pay?pa=${UPI_ID}&pn=RikiStore&am=${currentProduct.price}&cu=INR`; document.getElementById('buyModal').style.display='flex'; } }
    function login() { auth.signInWithEmailAndPassword(document.getElementById('l_email').value, document.getElementById('l_password').value).then(()=>{if(document.getElementById('l_email').value==="nitai.grp00@gmail.com")window.location.href="admin.html"; else closeModal('authModal');}).catch(e=>alert(e.message)); }
    function signup() { auth.createUserWithEmailAndPassword(document.getElementById('s_email').value, document.getElementById('s_password').value).then(c=>{db.ref('users/'+c.user.uid).set({name:document.getElementById('s_name').value, email:c.user.email, whatsapp:"", photoUrl:"https://i.ibb.co/5c63G0d/profile-placeholder.png"}); closeModal('authModal');}).catch(e=>alert(e.message)); }
    function loadProfile() { db.ref('users/'+currentUser.uid).on('value', s=>{const u=s.val(); document.getElementById('profile-content').innerHTML=`<div style="text-align:center;"><img src="${u.photoUrl}" style="width:80px;height:80px;border-radius:50%;margin-bottom:10px;"></div><label>Name</label><input id="p_name" value="${u.name}"><label>WhatsApp</label><input id="p_wa" value="${u.whatsapp}"><button class="btn-full" onclick="saveProfile()">Save</button>`}); }
    function saveProfile() { db.ref('users/'+currentUser.uid).update({name:document.getElementById('p_name').value, whatsapp:document.getElementById('p_wa').value}).then(()=>alert("Saved")); }
    function toggleAuthView() { document.getElementById('loginView').classList.toggle('hidden'); document.getElementById('signupView').classList.toggle('hidden'); }
    function closeModal(id) { document.getElementById(id).style.display='none'; }
    function closeFsModal() { document.getElementById('productModal').style.display='none'; }
</script>
</body>
</html>